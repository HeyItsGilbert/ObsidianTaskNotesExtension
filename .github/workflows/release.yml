# Obsidian Task Notes Extension - Build and Release Workflow
#
# This workflow builds EXE installers for x64 and ARM64 and creates a GitHub Release.
# It uses the psake build system via build.ps1.

name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Version number (leave empty to auto-detect from csproj)"
        required: false
        type: string
      create_release:
        description: "Create GitHub Release"
        required: false
        default: true
        type: boolean

env:
  DISPLAY_NAME: "Obsidian Task Notes"
  EXTENSION_NAME: "ObsidianTaskNotesExtension"
  DOTNET_VERSION: "9.0.x"

jobs:
  build:
    runs-on: windows-2022
    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Get version from project
        id: version
        run: |
          if ("${{ github.event.inputs.version }}" -ne "") {
            $version = "${{ github.event.inputs.version }}"
          } else {
            $projectFile = "${{ env.EXTENSION_NAME }}/${{ env.EXTENSION_NAME }}.csproj"
            $xml = [xml](Get-Content $projectFile)
            $version = $xml.Project.PropertyGroup.AppxPackageVersion | Select-Object -First 1
            if (-not $version) { 
              # Try to get version from Package.appxmanifest
              $manifest = [xml](Get-Content "${{ env.EXTENSION_NAME }}/Package.appxmanifest")
              # Convert to semver format
              $version = $manifest.Package.Identity.Version -replace '^(\d+)\.(\d+)\.(\d+)\.(\d+)$', '$1.$2.$3'
            }
            if (-not $version) { 
              $version = "0.0.1.0"
              Write-Host "No version found, using default"
            }
          }
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          Write-Host "Using version: $version"
        shell: pwsh

      - name: Validate version consistency
        run: |
          $version = "${{ steps.version.outputs.VERSION }}"
          Write-Host "Validating version consistency for: $version" -ForegroundColor Cyan

          # Extract versions from all sources
          $csprojFile = "${{ env.EXTENSION_NAME }}/${{ env.EXTENSION_NAME }}.csproj"
          $csprojXml = [xml](Get-Content $csprojFile)
          $csprojVersion = $csprojXml.Project.PropertyGroup.AppxPackageVersion | Select-Object -First 1

          $manifestFile = "${{ env.EXTENSION_NAME }}/Package.appxmanifest"
          $manifestXml = [xml](Get-Content $manifestFile)
          $manifestVersion = $manifestXml.Package.Identity.Version

          $changelogContent = Get-Content CHANGELOG.md -Raw
          $changelogHasVersion = $changelogContent -match "\[\s*$([regex]::Escape($version))\s*\]"

          $errors = @()

          # Validate csproj version
          if ($csprojVersion -ne "$version.0") {
            $errors += "‚ùå csproj version mismatch: expected '$version.0', got '$csprojVersion'"
          } else {
            Write-Host "‚úÖ csproj version matches: $csprojVersion"
          }

          # Validate manifest version
          if ($manifestVersion -ne "$version.0") {
            $errors += "‚ùå manifest version mismatch: expected '$version.0', got '$manifestVersion'"
          } else {
            Write-Host "‚úÖ manifest version matches: $manifestVersion"
          }

          # Validate changelog entry
          if (-not $changelogHasVersion) {
            $errors += "‚ùå CHANGELOG.md missing entry for version [$version]"
          } else {
            Write-Host "‚úÖ CHANGELOG.md contains version [$version]"
          }

          if ($errors.Count -gt 0) {
            foreach ($error in $errors) {
              Write-Host $error -ForegroundColor Red
            }
            throw "Version validation failed"
          }

          Write-Host "‚úÖ All versions are consistent!" -ForegroundColor Green
        shell: pwsh

      - name: Get Changelog Entry
        id: changelog_reader
        uses: mindsers/changelog-reader-action@v2
        with:
          validation_level: warn
          version: ${{ steps.version.outputs.VERSION }}
          path: ./CHANGELOG.md

      - name: Bootstrap and build with psake
        run: |
          Write-Host "Bootstrapping dependencies..." -ForegroundColor Green
          .\build.ps1 -Bootstrap -Task CICD
        shell: pwsh

      - name: Upload x64 installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.EXTENSION_NAME }}-x64-installer
          path: ${{ env.EXTENSION_NAME }}/bin/Release/installer/*-x64.exe
          if-no-files-found: warn

      - name: Upload ARM64 installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ env.EXTENSION_NAME }}-arm64-installer
          path: ${{ env.EXTENSION_NAME }}/bin/Release/installer/*-arm64.exe
          if-no-files-found: warn

      - name: Create GitHub Release
        if: ${{ github.event.inputs.create_release == 'true' }}
        uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ steps.version.outputs.VERSION }}
          name: "${{ env.DISPLAY_NAME }} v${{ steps.version.outputs.VERSION }}"
          body: |
            ## üéØ ${{ env.DISPLAY_NAME }} v${{ steps.version.outputs.VERSION }}

            **Released:** ${{ steps.changelog_reader.outputs.date }}

            ### What's Changed
            ${{ steps.changelog_reader.outputs.changes }}

            ---

            ### üì¶ Installation

            Download the installer for your system architecture:

            - **x64 (Intel/AMD)**: `${{ env.EXTENSION_NAME }}-Setup-${{ steps.version.outputs.VERSION }}-x64.exe`
            - **ARM64 (Windows on ARM)**: `${{ env.EXTENSION_NAME }}-Setup-${{ steps.version.outputs.VERSION }}-arm64.exe`

            #### Steps:
            1. Ensure [PowerToys](https://github.com/microsoft/PowerToys) is installed
            2. Download the appropriate installer from the Assets section below
            3. Run the installer
            4. The extension will be registered and available in Command Palette

            ### üîó More Information

            - [Repository](https://github.com/HeyItsGilbert/ObsidianTaskNotesExtension)
            - [TaskNotes API](https://tasknotes.dev/HTTP_API/)

            ### Requirements
            - Windows 10 version 19041 or later
            - [PowerToys](https://github.com/microsoft/PowerToys) with Command Palette enabled
            - TaskNotes plugin installed in Obsidian
          files: |
            ${{ env.EXTENSION_NAME }}/bin/Release/installer/*.exe
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Build summary
        run: |
          Write-Host "üéâ Build completed!" -ForegroundColor Green
          Write-Host "Version: ${{ steps.version.outputs.VERSION }}" -ForegroundColor Yellow
          if ("${{ github.event.inputs.create_release }}" -eq "true") {
            Write-Host "üì¶ GitHub Release created" -ForegroundColor Green
          } else {
            Write-Host "üìÅ Installers uploaded as artifacts (no release created)" -ForegroundColor Yellow
          }
        shell: pwsh
